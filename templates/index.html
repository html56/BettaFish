<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®èˆ† - AIèˆ†æƒ…åˆ†æå¹³å°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* é¢å¤–çš„æ ·å¼ä¿®å¤ */
        .console-line.system {
            color: var(--brand-primary);
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 4px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="system-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="system-header">
            <div class="system-logo">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" class="logo-img">
                <span>å¾®èˆ†</span>
            </div>
            <div class="system-nav">
                <button class="system-nav-button" id="openConfigButton">âš™ï¸ é…ç½®</button>
                <button class="system-nav-button primary" id="searchButtonTop">ğŸš€ å¼€å§‹åˆ†æ</button>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="system-main">
            <!-- å·¦ä¾§é¢æ¿ - åµŒå…¥çš„åº”ç”¨å†…å®¹ -->
            <div class="system-left-panel">
                <div class="system-card main-card">
                    <div class="system-card-header">
                        <div class="system-card-title" id="embeddedHeader">Insight Agent - ç§æœ‰æ•°æ®åº“æŒ–æ˜</div>
                        <div class="system-search-bar">
                            <input type="text" id="searchInput" placeholder="è¯·è¾“å…¥è¦åˆ†æçš„è¯é¢˜æˆ–å…³é”®è¯..." class="search-input">
                            <button id="searchButton" class="search-button">ğŸ” åˆ†æ</button>
                            <div class="upload-template-btn">
                                <input type="file" id="templateUpload" style="display: none;" accept=".txt,.md,.doc,.docx">
                                <label for="templateUpload" class="template-label">ğŸ“„ ä¸Šä¼ æ¨¡æ¿</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="system-panel-content" id="embeddedContent">
                        <!-- æ¬¢è¿ç•Œé¢ -->
                        <div class="welcome-container" id="welcomeContainer">
                            <div class="welcome-content">
                                <div class="welcome-icon">ğŸš€</div>
                                <h2>æ¬¢è¿ä½¿ç”¨å¾®èˆ†å¹³å°</h2>
                                <p>ä¸“ä¸šçš„AIèˆ†æƒ…åˆ†æè§£å†³æ–¹æ¡ˆ</p>
                                <div class="welcome-steps">
                                    <h4>ä½¿ç”¨æ­¥éª¤</h4>
                                    <ol class="welcome-steps-list">
                                        <li>ç‚¹å‡»å³ä¸Šè§’é…ç½®æŒ‰é’®ï¼Œè®¾ç½® LLM å‚æ•°</li>
                                        <li>åœ¨æœç´¢æ¡†è¾“å…¥è¦åˆ†æçš„è¯é¢˜æˆ–å…³é”®è¯</li>
                                        <li>ç‚¹å‡»"åˆ†æ"æŒ‰é’®å¯åŠ¨åˆ†ææµç¨‹</li>
                                        <li>å®æ—¶æŸ¥çœ‹å³ä¾§æ§åˆ¶å°çš„åˆ†æè¿›åº¦å’Œç»“æœ</li>
                                    </ol>
                                </div>
                            </div>
                        </div>

                        <!-- è®ºå›å®¹å™¨ -->
                        <div class="system-card" id="forumContainer" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: var(--brand-primary);">ğŸ¤– è®ºå›å¼•æ“</h4>
                            <div class="forum-chat-area" id="forumChatArea">
                                <!-- åŠ¨æ€æ·»åŠ çš„Engineå¯¹è¯æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>

                        <!-- æŠ¥å‘Šå®¹å™¨ -->
                        <div class="system-card" id="reportContainer" style="display: none;">
                            <h4 style="margin-bottom: 1rem; color: var(--brand-primary);">ğŸ“ˆ åˆ†ææŠ¥å‘Š</h4>
                            <div class="report-content" id="reportContent">
                                <!-- æŠ¥å‘Šå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é¢æ¿ - æ§åˆ¶å°å’Œå¼•æ“çŠ¶æ€ -->
            <div class="system-right-panel">
                <div class="system-console">
                    <div class="system-console-header">
                        <div class="system-console-title">ç³»ç»Ÿæ§åˆ¶å°</div>
                        <div class="system-console-controls">
                            <button class="system-console-control close" title="å…³é—­"></button>
                            <button class="system-console-control minimize" title="æœ€å°åŒ–"></button>
                            <button class="system-console-control maximize" title="æœ€å¤§åŒ–"></button>
                        </div>
                    </div>

                    <div class="system-panel-content" style="padding: 1rem;">
                        <!-- å¼•æ“åˆ‡æ¢å™¨ -->
                        <div class="system-app-switcher">
                            <button class="system-app-tab app-button active" data-app="insight">
                                <div class="system-status-indicator" id="status-insight"></div>
                                Insight Agent
                            </button>
                            <button class="system-app-tab app-button" data-app="media">
                                <div class="system-status-indicator" id="status-media"></div>
                                Media Agent
                            </button>
                            <button class="system-app-tab app-button" data-app="query">
                                <div class="system-status-indicator" id="status-query"></div>
                                Query Agent
                            </button>
                            <button class="system-app-tab app-button" data-app="forum">
                                <div class="system-status-indicator running" id="status-forum"></div>
                                Forum Host
                            </button>
                            <button class="system-app-tab app-button locked" data-app="report" title="éœ€ç­‰å¾…å…¶ä½™ä¸‰ä¸ªAgentå·¥ä½œå®Œæ¯•">
                                <div class="system-status-indicator" id="status-report"></div>
                                Report Agent
                            </button>
                        </div>

                        <!-- æ§åˆ¶å°è¾“å‡º -->
                        <div class="console-divider"></div>
                        <div class="system-console-output" id="consoleOutput">
                            <div class="console-line system">[ç³»ç»Ÿ] åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ç³»ç»ŸçŠ¶æ€æ  -->
        <footer class="system-status-bar">
            <div class="system-status-left">
                <span id="systemStatus">ç³»ç»Ÿå°±ç»ª</span>
                <span id="lastUpdateTime">--:--:--</span>
            </div>
            <div class="system-status-right">
                <span>å¾®èˆ† v1.1.2</span>
                <span id="connectionStatus">â— å·²è¿æ¥</span>
            </div>
        </footer>
    </div>

    <!-- é…ç½®æ¨¡æ€æ¡† -->
    <div class="config-modal-overlay" id="configModal">
        <div class="config-modal-inner">
            <div class="config-modal">
                <div class="config-modal-header">
                    <div class="config-modal-title">LLM é…ç½® - ä¸.envæ–‡ä»¶åŒå‘åŒæ­¥</div>
                    <div class="config-modal-actions">
                        <button class="config-secondary-button" id="refreshConfigButton">ğŸ”„ åˆ·æ–°</button>
                        <button class="config-close-button" id="closeConfigModal">Ã—</button>
                    </div>
                </div>
                <div class="config-modal-body" id="configFormContainer">
                    <!-- é…ç½®è¡¨å•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="config-modal-footer">
                    <div class="config-status-message" id="configStatusMessage"></div>
                    <div class="config-modal-footer-actions">
                        <button class="config-save-button" id="saveConfigButton">ğŸ’¾ ä¿å­˜</button>
                        <button class="config-start-button" id="startSystemButton">ğŸš€ ä¿å­˜å¹¶å¯åŠ¨ç³»ç»Ÿ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="message"></div>

    <script>
        // å…¨å±€å˜é‡
        let socket;
        let currentApp = 'insight';
        let appStatus = {
            insight: 'stopped',
            media: 'stopped',
            query: 'stopped',
            forum: 'stopped',
            report: 'stopped'
        };
        let lastLineCount = {};
        let forumLogLineCount = 0;
        let systemStarted = false;
        let systemStarting = false;
        let configDirty = false;
        let configModalLocked = false;
        let currentLogAbortController = null;

        const appNames = {
            insight: 'Insight Engine',
            media: 'Media Engine', 
            query: 'Query Engine',
            forum: 'Forum Engine',
            report: 'Report Engine'
        };

        const agentTitles = {
            insight: 'Insight Agent - ç§æœ‰æ•°æ®åº“æŒ–æ˜',
            media: 'Media Agent - å¤šæ¨¡æ€å†…å®¹åˆ†æ', 
            query: 'Query Agent - ç²¾å‡†ä¿¡æ¯æœç´¢',
            forum: 'Forum Engine - å¤šæ™ºèƒ½ä½“äº¤æµ',
            report: 'Report Agent - æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ'
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeEventListeners();
            updateTime();
            setInterval(updateTime, 1000);
            checkStatus();
            setInterval(checkStatus, 5000);
            
            // å®šæœŸåˆ·æ–°æ§åˆ¶å°è¾“å‡º
            setInterval(() => {
                refreshConsoleOutput();
            }, 1000);
            
            // å»¶è¿Ÿé¢„åŠ è½½iframe
            setTimeout(() => {
                preloadIframes();
            }, 3000);
        });

        // Socket.IOè¿æ¥
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                document.getElementById('connectionStatus').textContent = 'â— å·²è¿æ¥';
                document.getElementById('connectionStatus').style.color = '#4caf50';
            });

            socket.on('disconnect', function() {
                document.getElementById('connectionStatus').textContent = 'â— è¿æ¥æ–­å¼€';
                document.getElementById('connectionStatus').style.color = '#f44336';
            });

            socket.on('console_output', function(data) {
                // ä¸¥æ ¼æ£€æŸ¥ data.app æ˜¯å¦ç­‰äºå½“å‰æ¿€æ´»çš„ currentApp
                if (data.app === currentApp) {
                    addConsoleOutput(data.line);
                    
                    // æ›´æ–°è¡Œè®¡æ•°ï¼Œé˜²æ­¢è½®è¯¢é‡å¤æ·»åŠ 
                    if (currentApp !== 'report' && currentApp !== 'forum') {
                        lastLineCount[data.app] = (lastLineCount[data.app] || 0) + 1;
                    }
                } else {
                    // å¦‚æœä¸æ˜¯å½“å‰åº”ç”¨ï¼Œåªæ›´æ–°è®¡æ•°ï¼Œä¸æ˜¾ç¤º
                    if (data.app !== 'report' && data.app !== 'forum') {
                        lastLineCount[data.app] = (lastLineCount[data.app] || 0) + 1;
                    }
                }
                
                // å¦‚æœæ˜¯forumçš„è¾“å‡ºï¼ŒåŒæ—¶ä¹Ÿå¤„ç†ä¸ºè®ºå›æ¶ˆæ¯
                if (data.app === 'forum') {
                    const parsed = parseForumMessage(data.line);
                    if (parsed) {
                        addForumMessage(parsed);
                    }
                }
            });

            socket.on('status_update', function(data) {
                updateAppStatus(data);
            });
        }

        function initializeEventListeners() {
            // æœç´¢æŒ‰é’®
            document.getElementById('searchButton').addEventListener('click', performSearch);
            document.getElementById('searchButtonTop').addEventListener('click', () => {
                document.getElementById('searchInput').focus();
            });
            
            // æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.app-button').forEach(button => {
                button.addEventListener('click', () => {
                    const app = button.getAttribute('data-app');
                    switchToApp(app);
                });
            });

            // é…ç½®å¼¹çª—
            document.getElementById('openConfigButton').addEventListener('click', () => openConfigModal());
            document.getElementById('closeConfigModal').addEventListener('click', () => closeConfigModal());
            document.getElementById('saveConfigButton').addEventListener('click', () => saveConfig());
            document.getElementById('startSystemButton').addEventListener('click', () => startSystem());
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
            document.getElementById('lastUpdateTime').textContent = timeString;
        }

        function checkStatus() {
            fetch('/api/status')
                .then(res => res.json())
                .then(data => {
                    updateAppStatus(data);
                });
            
            fetch('/api/system/status')
                .then(res => res.json())
                .then(data => {
                    systemStarted = data.started;
                    document.getElementById('systemStatus').textContent = systemStarted ? 'ç³»ç»Ÿè¿è¡Œä¸­' : 'ç³»ç»Ÿå°±ç»ª';
                });
        }

        function updateAppStatus(data) {
            for (const [app, info] of Object.entries(data)) {
                appStatus[app] = info.status;
                const indicator = document.getElementById(`status-${app}`);
                if (indicator) {
                    indicator.className = 'system-status-indicator ' + info.status;
                }
            }
        }

        function switchToApp(app) {
            if (app === currentApp) return;

            // æ£€æŸ¥é”å®šçŠ¶æ€
            if (app === 'report' && document.querySelector(`[data-app="report"]`).classList.contains('locked')) {
                showMessage('éœ€ç­‰å¾…å…¶ä½™ä¸‰ä¸ªAgentå·¥ä½œå®Œæ¯•', 'error');
                return;
            }

            // 1. å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
            if (currentLogAbortController) {
                currentLogAbortController.abort();
            }

            // 2. å½»åº•æ¸…ç©ºæ§åˆ¶å°
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = '';

            // 3. æ›´æ–° UI çŠ¶æ€
            document.querySelectorAll('.app-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-app="${app}"]`).classList.add('active');
            
            currentApp = app;
            document.getElementById('embeddedHeader').textContent = agentTitles[app] || appNames[app];

            // 4. æ˜¾ç¤ºå¯¹åº”å®¹å™¨
            document.getElementById('welcomeContainer').style.display = 'none';
            document.getElementById('forumContainer').style.display = (app === 'forum') ? 'block' : 'none';
            document.getElementById('reportContainer').style.display = (app === 'report') ? 'block' : 'none';
            
            // 5. æ·»åŠ åˆ‡æ¢æç¤º
            const div = document.createElement('div');
            div.className = 'console-line system';
            div.textContent = `[ç³»ç»Ÿ] åˆ‡æ¢åˆ° ${appNames[app] || app}`;
            consoleOutput.appendChild(div);

            // 6. åŠ è½½å†å²æ—¥å¿—
            lastLineCount[app] = 0;
            loadConsoleOutput(app);
            
            // 7. æ›´æ–° iframe æ˜¾ç¤º
            updateEmbeddedPage(app);
        }

        function loadConsoleOutput(app) {
            if (app === 'report') return;
            
            currentLogAbortController = new AbortController();
            const signal = currentLogAbortController.signal;

            fetch(`/api/output/${app}`, { signal })
                .then(res => res.json())
                .then(data => {
                    if (app !== currentApp) return;
                    if (data.success) {
                        const consoleOutput = document.getElementById('consoleOutput');
                        if (data.output && data.output.length > 0) {
                            data.output.forEach(line => {
                                const div = document.createElement('div');
                                div.className = 'console-line';
                                div.textContent = line;
                                consoleOutput.appendChild(div);
                            });
                            lastLineCount[app] = data.output.length;
                        } else {
                            const div = document.createElement('div');
                            div.className = 'console-line';
                            div.textContent = '[ç³»ç»Ÿ] æš‚æ— æ—¥å¿—è¾“å‡º';
                            consoleOutput.appendChild(div);
                        }
                        consoleOutput.scrollTop = consoleOutput.scrollHeight;
                    }
                })
                .catch(err => {
                    if (err.name !== 'AbortError') console.error('åŠ è½½æ—¥å¿—å¤±è´¥', err);
                });
        }

        function refreshConsoleOutput() {
            if (currentApp === 'report' || !systemStarted) return;
            
            fetch(`/api/output/${currentApp}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.output.length > (lastLineCount[currentApp] || 0)) {
                        const consoleOutput = document.getElementById('consoleOutput');
                        const newLines = data.output.slice(lastLineCount[currentApp] || 0);
                        newLines.forEach(line => {
                            const div = document.createElement('div');
                            div.className = 'console-line';
                            div.textContent = line;
                            consoleOutput.appendChild(div);
                        });
                        lastLineCount[currentApp] = data.output.length;
                        consoleOutput.scrollTop = consoleOutput.scrollHeight;
                    }
                });
        }

        function addConsoleOutput(line) {
            const consoleOutput = document.getElementById('consoleOutput');
            const div = document.createElement('div');
            div.className = 'console-line';
            div.textContent = line;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return showMessage('è¯·è¾“å…¥æœç´¢å†…å®¹', 'error');
            
            showMessage('æœç´¢è¯·æ±‚å·²å‘é€ï¼Œæ­£åœ¨å¯åŠ¨åˆ†æ...', 'success');
            
            // æ¨¡æ‹Ÿå‘é€åˆ°å„ Engine
            Object.keys(preloadedIframes).forEach(app => {
                if (appStatus[app] === 'running') {
                    const port = { insight: 8501, media: 8502, query: 8503 }[app];
                    preloadedIframes[app].src = `http://${window.location.hostname}:${port}?query=${encodeURIComponent(query)}&auto_search=true`;
                }
            });
        }

        // Iframe é¢„åŠ è½½é€»è¾‘
        let preloadedIframes = {};
        function preloadIframes() {
            const ports = { insight: 8501, media: 8502, query: 8503 };
            const container = document.getElementById('embeddedContent');
            for (const [app, port] of Object.entries(ports)) {
                const iframe = document.createElement('iframe');
                iframe.id = `iframe-${app}`;
                iframe.src = `http://${window.location.hostname}:${port}`;
                iframe.style.display = 'none';
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                container.appendChild(iframe);
                preloadedIframes[app] = iframe;
            }
        }

        function updateEmbeddedPage(app) {
            Object.values(preloadedIframes).forEach(f => f.style.display = 'none');
            if (preloadedIframes[app]) {
                preloadedIframes[app].style.display = 'block';
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message show ${type}`;
            setTimeout(() => msg.classList.remove('show'), 3000);
        }

        // é…ç½®ç›¸å…³
        function openConfigModal() {
            document.getElementById('configModal').classList.add('visible');
            fetch('/api/config')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('configFormContainer');
                    container.innerHTML = '';
                    for (const [key, val] of Object.entries(data.config)) {
                        const div = document.createElement('div');
                        div.className = 'config-field';
                        div.innerHTML = `<label>${key}</label><input type="text" data-key="${key}" value="${val}">`;
                        container.appendChild(div);
                    }
                });
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('visible');
        }

        function saveConfig() {
            const updates = {};
            document.querySelectorAll('#configFormContainer input').forEach(input => {
                updates[input.getAttribute('data-key')] = input.value;
            });
            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            }).then(() => showMessage('é…ç½®å·²ä¿å­˜', 'success'));
        }

        function startSystem() {
            saveConfig();
            fetch('/api/system/start', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showMessage('ç³»ç»Ÿå¯åŠ¨æˆåŠŸ', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showMessage('å¯åŠ¨å¤±è´¥: ' + data.message, 'error');
                    }
                });
        }

        function parseForumMessage(line) {
            // ç®€å•çš„è§£æé€»è¾‘
            if (line.includes('[FORUM]')) return { content: line };
            return null;
        }

        function addForumMessage(msg) {
            const area = document.getElementById('forumChatArea');
            const div = document.createElement('div');
            div.className = 'forum-message';
            div.textContent = msg.content;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }
    </script>
</body>
</html>
